from django.shortcuts import render
from .models import Levels
from django.core.paginator import Paginator, PageNotAnInteger, EmptyPage
import psycopg2


conn = psycopg2.connect(database = "levels", user = "postgres", password = "postgres", host = "127.0.0.1", port = "5432")
base = conn.cursor()

def all_levels(request):
    filter_by_olt = request.GET.get('filter_by_olt')
    filter_on_page = request.GET.get('filter_on_page')
    filter_by_level = request.GET.get('filter_by_level')
    filter_by_mac = request.GET.get('filter_by_mac') 
    filter_by_epon = request.GET.get('filter_by_epon')
    if filter_by_mac == None: filter_by_mac =''
    filter_by_mac = filter_by_mac.replace(':','').replace('.','').lower()
    filter_by_mac = ':'.join(filter_by_mac[i:i+2] for i in range(0, len(filter_by_mac), 2))
    if filter_by_epon  == None: filter_by_epon =''
    if filter_by_olt  == None: filter_by_olt =''
    column = Levels.objects.raw(
        "SELECT 1 id, column_name FROM INFORMATION_SCHEMA. COLUMNS WHERE TABLE_NAME = 'levels_levels'")
    name_column = []
    titles = []
    for item in column:
        if 'level' in item.column_name:
            name_column.append(item.column_name)
            titles.append((item.column_name).replace("_","-")[6:])
    name_column.reverse()
    titles.reverse()
    name_column = name_column[:14]
    titles = titles[:14]

    if filter_by_level is None or filter_by_level == '':
        filter_by_level = ''
        select = "SELECT * FROM levels_levels WHERE "+name_column[0]+" is NOT Null AND mac LIKE '"+"%%"+filter_by_mac+"%%"+"' AND olt LIKE '"+"%%"+filter_by_olt+"%%"+"' AND epon LIKE '"+"%%"+filter_by_epon+"%%"+"' ORDER BY olt, CAST(split_part(split_part(epon,':',1),'/','2') as INT), CAST("+name_column[0]+" as FLOAT), CAST(split_part(epon,':',2) as INT);"
        levels = Levels.objects.raw(select)
        for level in levels:
            try:
                level.one = float(level.__dict__[name_column[0]])
            except:
                level.one = level.__dict__[name_column[0]]
            level.two = level.__dict__[name_column[1]]
            level.three = level.__dict__[name_column[2]]
            level.four = level.__dict__[name_column[3]]
            level.five = level.__dict__[name_column[4]]
            level.six = level.__dict__[name_column[5]]
            level.seven = level.__dict__[name_column[6]]
            level.eight = level.__dict__[name_column[7]]
            level.nine = level.__dict__[name_column[8]]
            level.ten = level.__dict__[name_column[9]]
            level.eleven = level.__dict__[name_column[10]]
            level.twelve = level.__dict__[name_column[11]]
            level.thirteen = level.__dict__[name_column[12]]
            level.fourteen = level.__dict__[name_column[13]]

    else:
        try:
            if float(filter_by_level) != 0.245654:
                select = "SELECT main.* FROM levels_levels main JOIN (SELECT sub.olt, COUNT(olt) as cnt FROM levels_levels  sub WHERE sub."+name_column[0]+" is NOT Null AND sub."+name_column[0]+" !='Down' AND cast(sub."+name_column[0]+" as FLOAT) between -40 AND "+filter_by_level+" GROUP BY sub.olt) sub ON (sub.olt = main.olt) WHERE main."+name_column[0]+" is not Null AND main."+name_column[0]+"!='Down' AND cast(main."+name_column[0]+"  as FLOAT) between -40 AND "+filter_by_level+" AND main.mac LIKE '"+"%%"+filter_by_mac+"%%"+"' AND main.olt LIKE '"+"%%"+filter_by_olt+"%%"+"' AND main.epon LIKE '"+"%%"+filter_by_epon+"%%"+"'ORDER BY sub.cnt DESC, main.olt, CAST(split_part(split_part(main.epon,':',1),'/','2') as INT), "+name_column[0]+" DESC, CAST(split_part(main.epon,':',2) as INT);"
                levels = Levels.objects.raw(select)
                for level in levels:
                    try:
                        level.one = float(level.__dict__[name_column[0]])
                    except:
                        level.one = level.__dict__[name_column[0]]
                    level.two = level.__dict__[name_column[1]]
                    level.three = level.__dict__[name_column[2]]
                    level.four = level.__dict__[name_column[3]]
                    level.five = level.__dict__[name_column[4]]
                    level.six = level.__dict__[name_column[5]]
                    level.seven = level.__dict__[name_column[6]]
                    level.eight = level.__dict__[name_column[7]]
                    level.nine = level.__dict__[name_column[8]]
                    level.ten = level.__dict__[name_column[9]]
                    level.eleven = level.__dict__[name_column[10]]
                    level.twelve = level.__dict__[name_column[11]]
                    level.thirteen = level.__dict__[name_column[12]]
                    level.fourteen = level.__dict__[name_column[13]]

        except:
            select = "SELECT * FROM levels_levels WHERE "+name_column[0]+" is NOT Null AND mac LIKE '"+"%%"+filter_by_mac+"%%"+"' AND olt LIKE '"+"%%"+filter_by_olt+"%%"+"' AND epon LIKE '"+"%%"+filter_by_epon+"%%"+"' ORDER BY olt, CAST(split_part(split_part(epon,':',1),'/','2') as INT), cast("+name_column[0]+" as FLOAT), CAST(split_part(epon,':',2) as INT);"
            levels = Levels.objects.raw(select)
            for level in levels:
                try:
                    level.one = float(level.__dict__[name_column[0]])
                except:
                    level.one = level.__dict__[name_column[0]]
                level.two = level.__dict__[name_column[1]]
                level.three = level.__dict__[name_column[2]]
                level.four = level.__dict__[name_column[3]]
                level.five = level.__dict__[name_column[4]]
                level.six = level.__dict__[name_column[5]]
                level.seven = level.__dict__[name_column[6]]
                level.eight = level.__dict__[name_column[7]]
                level.nine = level.__dict__[name_column[8]]
                level.ten = level.__dict__[name_column[9]]
                level.eleven = level.__dict__[name_column[10]]
                level.twelve = level.__dict__[name_column[11]]
                level.thirteen = level.__dict__[name_column[12]]
                level.fourteen = level.__dict__[name_column[13]]

    total = len(levels)
    if filter_on_page == None:
        filter_on_page = '10'
    if filter_on_page != 'all':
        paginator = Paginator(levels, int(filter_on_page))
        page = request.GET.get('page')
        try:
            levels = paginator.page(page)
        except PageNotAnInteger:
            levels = paginator.page(1)
        except EmptyPage:
            levels = paginator.page(paginator.num_pages)
    context = {'levels': levels, 'name_column':name_column, 'total':total, 'filter_by_level':filter_by_level, 'titles':titles, 'filter_on_page':filter_on_page, 'filter_by_epon':filter_by_epon, 'filter_by_mac':filter_by_mac, 'filter_by_olt':filter_by_olt}
    return render(request, 'levels/levels.html', context)


def levels_by_olt(request, olt):
    filter_on_page = request.GET.get('filter_on_page')
    filter_by_level = request.GET.get('filter_by_level')
    filter_by_mac = request.GET.get('filter_by_mac') 
    filter_by_epon = request.GET.get('filter_by_epon')
    if filter_by_mac == None: filter_by_mac =''
    filter_by_mac = filter_by_mac.replace(':','').replace('.','').lower()
    filter_by_mac = ':'.join(filter_by_mac[i:i+2] for i in range(0, len(filter_by_mac), 2))
    if filter_by_epon  == None: filter_by_epon =''

    column = Levels.objects.raw(
        "SELECT 1 id, column_name FROM INFORMATION_SCHEMA. COLUMNS WHERE TABLE_NAME = 'levels_levels'")
    name_column = []
    titles = []
    for item in column:
        if 'level' in item.column_name:
            name_column.append(item.column_name)
            titles.append((item.column_name).replace("_","-")[6:])
    name_column.reverse()
    titles.reverse()
    name_column = name_column[:14]
    titles = titles[:14]
    filter_by_level = request.GET.get('filter_by_level')
    
    if filter_by_level is None or filter_by_level == '':
        filter_by_level = ''
        select = "SELECT *, cast("+name_column[0]+" as decimal(12,1))-cast("+name_column[1]+" as  decimal(12,1)) as last_diff  FROM levels_levels WHERE "+name_column[0]+" is not Null AND olt='"+olt+"' AND mac LIKE '"+"%%"+filter_by_mac+"%%"+"' AND epon LIKE '"+"%%"+filter_by_epon+"%%"+"' ORDER BY CAST(split_part(split_part(epon,':',1),'/','2') as INT), CAST("+name_column[0]+" as FLOAT) ASC, CAST(split_part(epon,':',2) as INT);"
        levels = Levels.objects.raw(select)
        for level in levels:
            try:
                level.one = float(level.__dict__[name_column[0]])
            except:
                level.one = level.__dict__[name_column[0]]
            level.two = level.__dict__[name_column[1]]
            level.three = level.__dict__[name_column[2]]
            level.four = level.__dict__[name_column[3]]
            level.five = level.__dict__[name_column[4]]
            level.six = level.__dict__[name_column[5]]
            level.seven = level.__dict__[name_column[6]]
            level.eight = level.__dict__[name_column[7]]
            level.nine = level.__dict__[name_column[8]]
            level.ten = level.__dict__[name_column[9]]
            level.eleven = level.__dict__[name_column[10]]
            level.twelve = level.__dict__[name_column[11]]
            level.thirteen = level.__dict__[name_column[12]]
            level.fourteen = level.__dict__[name_column[13]]
    else:
        try:
            if float(filter_by_level) != 0.245654:
                select = "SELECT *, cast("+name_column[0]+" as decimal(12,1))-cast("+name_column[1]+" as  decimal(12,1)) as last_diff  FROM levels_levels WHERE olt='"+olt+"' AND "+name_column[0]+" is not Null AND mac LIKE '"+"%%"+filter_by_mac+"%%"+"' AND epon LIKE '"+"%%"+filter_by_epon+"%%"+"' AND "+name_column[0]+"!='Down' AND cast("+name_column[0]+" as FLOAT) between -40 AND "+filter_by_level+" order BY  CAST(split_part(split_part(epon,':',1),'/','2') as INT),cast("+name_column[0]+" as FLOAT), CAST(split_part(epon,':',2) as INT);"
                levels = Levels.objects.raw(select)
                for level in levels:
                    try:
                        level.one = float(level.__dict__[name_column[0]])
                    except:
                        level.one = level.__dict__[name_column[0]]
                    level.two = level.__dict__[name_column[1]]
                    level.three = level.__dict__[name_column[2]]
                    level.four = level.__dict__[name_column[3]]
                    level.five = level.__dict__[name_column[4]]
                    level.six = level.__dict__[name_column[5]]
                    level.seven = level.__dict__[name_column[6]]
                    level.eight = level.__dict__[name_column[7]]
                    level.nine = level.__dict__[name_column[8]]
                    level.ten = level.__dict__[name_column[9]]
                    level.eleven = level.__dict__[name_column[10]]
                    level.twelve = level.__dict__[name_column[11]]
                    level.thirteen = level.__dict__[name_column[12]]
                    level.fourteen = level.__dict__[name_column[13]]

        except:
            select = "SELECT *, cast("+name_column[0]+" as decimal(12,1))-cast("+name_column[1]+" as  decimal(12,1)) as last_diff  FROM levels_levels WHERE "+name_column[0]+" is not Null AND olt='"+olt+"' AND mac LIKE '"+"%%"+filter_by_mac+"%%"+"' AND epon LIKE '"+"%%"+filter_by_epon+"%%"+"' ORDER BY CAST(split_part(split_part(epon,':',1),'/','2') as INT), cast("+name_column[0]+" as FLOAT), CAST(split_part(epon,':',2) as INT);"
            levels = Levels.objects.raw(select)
            for level in levels:
                try:
                    level.one = float(level.__dict__[name_column[0]])
                except:
                    level.one = level.__dict__[name_column[0]]
                level.two = level.__dict__[name_column[1]]
                level.three = level.__dict__[name_column[2]]
                level.four = level.__dict__[name_column[3]]
                level.five = level.__dict__[name_column[4]]
                level.six = level.__dict__[name_column[5]]
                level.seven = level.__dict__[name_column[6]]
                level.eight = level.__dict__[name_column[7]]
                level.nine = level.__dict__[name_column[8]]
                level.ten = level.__dict__[name_column[9]]
                level.eleven = level.__dict__[name_column[10]]
                level.twelve = level.__dict__[name_column[11]]
                level.thirteen = level.__dict__[name_column[12]]
                level.fourteen = level.__dict__[name_column[13]]

    total = len(levels)
    if filter_on_page == None:
        filter_on_page = '10'
    if filter_on_page != 'all':
        paginator = Paginator(levels, int(filter_on_page))
        page = request.GET.get('page')
        try:
            levels = paginator.page(page)
        except PageNotAnInteger:
            levels = paginator.page(1)
        except EmptyPage:
            levels = paginator.page(paginator.num_pages)
    context = {'olt':olt, 'levels': levels, 'filter_by_level': filter_by_level, 'total': total, 'titles':titles, 'filter_on_page':filter_on_page, 'filter_by_epon':filter_by_epon, 'filter_by_mac':filter_by_mac}
    return render(request, 'levels/levels_olt.html', context)


def olt_list(request):
    filter_by_level = request.GET.get('filter_by_level')
    filter_by_olt = request.GET.get('filter_by_olt')
    if filter_by_olt  == None: filter_by_olt =''
    column = Levels.objects.raw(
        "SELECT 1 id, column_name FROM INFORMATION_SCHEMA. COLUMNS WHERE TABLE_NAME = 'levels_levels'")
    name_column = []
    for item in column:
        if 'level' in item.column_name:
            name_column.append(item.column_name)
    if filter_by_level == None or filter_by_level == "":
        filter_by_level = -27
        select = "SELECT 1 id, main.olt, greatest(epon01.level, epon02.level, epon03.level, epon04.level, epon05.level, epon06.level, epon07.level, epon08.level,epon09.level, epon10.level, epon11.level, epon12.level, epon13.level, epon14.level, epon15.level, epon16.level) as max_on_one_epon, main.count, COALESCE(epon01.level, 0) AS epon01, COALESCE(epon02.level, 0) AS epon02, COALESCE(epon03.level, 0) AS epon03, COALESCE(epon04.level, 0) AS epon04, COALESCE(epon05.level, 0) AS epon05, COALESCE(epon06.level, 0) AS epon06, COALESCE(epon07.level, 0) AS epon07, COALESCE(epon08.level, 0) AS epon08, COALESCE(epon09.level, 0) AS epon09, COALESCE(epon10.level, 0) AS epon10, COALESCE(epon11.level, 0) AS epon11, COALESCE(epon12.level, 0) AS epon12, COALESCE(epon13.level, 0) AS epon13, COALESCE(epon14.level, 0) AS epon14, COALESCE(epon15.level, 0) AS epon15, COALESCE(epon16.level, 0) AS epon16 FROM (SELECT olt, COUNT(olt) AS count FROM levels_levels WHERE "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt ) main LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/1:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon01 ON (main.olt = epon01.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/2:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon02 ON (main.olt = epon02.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/3:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon03 ON (main.olt = epon03.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/4:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon04 ON (main.olt = epon04.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/5:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon05 ON (main.olt = epon05.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/6:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon06 ON (main.olt = epon06.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/7:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon07 ON (main.olt = epon07.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/8:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon08 ON (main.olt = epon08.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/9:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon09 ON (main.olt = epon09.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/10:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon10 ON (main.olt = epon10.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/11:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon11 ON (main.olt = epon11.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/12:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon12 ON (main.olt = epon12.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/13:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon13 ON (main.olt = epon13.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/14:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon14 ON (main.olt = epon14.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/15:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon15 ON (main.olt = epon15.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/16:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon16 ON (main.olt = epon16.olt) ORDER BY greatest(epon01.level, epon02.level, epon03.level, epon04.level, epon05.level, epon06.level, epon07.level, epon08.level,epon09.level, epon10.level, epon11.level, epon12.level, epon13.level, epon14.level, epon15.level, epon16.level) DESC, main.count DESC; "
        levels_list = Levels.objects.raw(select)
    else:
        try:
            select = "SELECT 1 id, main.olt, greatest(epon01.level, epon02.level, epon03.level, epon04.level, epon05.level, epon06.level, epon07.level, epon08.level,epon09.level, epon10.level, epon11.level, epon12.level, epon13.level, epon14.level, epon15.level, epon16.level) as max_on_one_epon, main.count, COALESCE(epon01.level, 0) AS epon01, COALESCE(epon02.level, 0) AS epon02, COALESCE(epon03.level, 0) AS epon03, COALESCE(epon04.level, 0) AS epon04, COALESCE(epon05.level, 0) AS epon05, COALESCE(epon06.level, 0) AS epon06, COALESCE(epon07.level, 0) AS epon07, COALESCE(epon08.level, 0) AS epon08, COALESCE(epon09.level, 0) AS epon09, COALESCE(epon10.level, 0) AS epon10, COALESCE(epon11.level, 0) AS epon11, COALESCE(epon12.level, 0) AS epon12, COALESCE(epon13.level, 0) AS epon13, COALESCE(epon14.level, 0) AS epon14, COALESCE(epon15.level, 0) AS epon15, COALESCE(epon16.level, 0) AS epon16 FROM (SELECT olt, COUNT(olt) AS count FROM levels_levels WHERE "+name_column[-1]+" is NOT Null AND olt LIKE '"+"%%"+filter_by_olt+"%%"+"' AND "+name_column[-1]+" !='Down' AND cast("+name_column[-1]+" as FLOAT) between -40 AND "+ filter_by_level +" GROUP BY olt) main LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/1:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND "+ filter_by_level +" GROUP BY olt) epon01 ON (main.olt = epon01.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/2:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND "+ filter_by_level +" GROUP BY olt) epon02 ON (main.olt = epon02.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/3:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND "+ filter_by_level +" GROUP BY olt) epon03 ON (main.olt = epon03.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/4:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND "+ filter_by_level +" GROUP BY olt) epon04 ON (main.olt = epon04.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/5:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND "+ filter_by_level +" GROUP BY olt) epon05 ON (main.olt = epon05.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/6:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND "+ filter_by_level +" GROUP BY olt) epon06 ON (main.olt = epon06.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/7:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND "+ filter_by_level +" GROUP BY olt) epon07 ON (main.olt = epon07.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/8:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND "+ filter_by_level +" GROUP BY olt) epon08 ON (main.olt = epon08.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/9:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND "+ filter_by_level +" GROUP BY olt) epon09 ON (main.olt = epon09.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/10:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND "+ filter_by_level +" GROUP BY olt) epon10 ON (main.olt = epon10.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/11:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND "+ filter_by_level +" GROUP BY olt) epon11 ON (main.olt = epon11.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/12:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND "+ filter_by_level +" GROUP BY olt) epon12 ON (main.olt = epon12.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/13:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND "+ filter_by_level +" GROUP BY olt) epon13 ON (main.olt = epon13.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/14:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND "+ filter_by_level +" GROUP BY olt) epon14 ON (main.olt = epon14.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/15:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND "+ filter_by_level +" GROUP BY olt) epon15 ON (main.olt = epon15.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/16:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND "+ filter_by_level +" GROUP BY olt) epon16 ON (main.olt = epon16.olt) ORDER BY greatest(epon01.level, epon02.level, epon03.level, epon04.level, epon05.level, epon06.level, epon07.level, epon08.level,epon09.level, epon10.level, epon11.level, epon12.level, epon13.level, epon14.level, epon15.level, epon16.level) DESC, main.count DESC;"
            levels_list = Levels.objects.raw(select)
        except:
            select = "SELECT 1 id, main.olt, greatest(epon01.level, epon02.level, epon03.level, epon04.level, epon05.level, epon06.level, epon07.level, epon08.level,epon09.level, epon10.level, epon11.level, epon12.level, epon13.level, epon14.level, epon15.level, epon16.level) as max_on_one_epon, main.count, COALESCE(epon01.level, 0) AS epon01, COALESCE(epon02.level, 0) AS epon02, COALESCE(epon03.level, 0) AS epon03, COALESCE(epon04.level, 0) AS epon04, COALESCE(epon05.level, 0) AS epon05, COALESCE(epon06.level, 0) AS epon06, COALESCE(epon07.level, 0) AS epon07, COALESCE(epon08.level, 0) AS epon08, COALESCE(epon09.level, 0) AS epon09, COALESCE(epon10.level, 0) AS epon10, COALESCE(epon11.level, 0) AS epon11, COALESCE(epon12.level, 0) AS epon12, COALESCE(epon13.level, 0) AS epon13, COALESCE(epon14.level, 0) AS epon14, COALESCE(epon15.level, 0) AS epon15, COALESCE(epon16.level, 0) AS epon16 FROM (SELECT olt, COUNT(olt) AS count FROM levels_levels WHERE "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt ) main LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/1:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon01 ON (main.olt = epon01.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/2:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon02 ON (main.olt = epon02.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/3:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon03 ON (main.olt = epon03.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/4:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon04 ON (main.olt = epon04.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/5:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon05 ON (main.olt = epon05.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/6:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon06 ON (main.olt = epon06.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/7:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon07 ON (main.olt = epon07.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/8:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon08 ON (main.olt = epon08.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/9:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon09 ON (main.olt = epon09.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/10:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon10 ON (main.olt = epon10.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/11:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon11 ON (main.olt = epon11.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/12:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon12 ON (main.olt = epon12.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/13:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon13 ON (main.olt = epon13.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/14:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon14 ON (main.olt = epon14.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/15:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon15 ON (main.olt = epon15.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/16:%%' AND "+name_column[-1]+" is NOT Null AND "+name_column[-1]+" !='Down' AND cast( "+name_column[-1]+" as FLOAT) between -40 AND -27 GROUP BY olt) epon16 ON (main.olt = epon16.olt) ORDER BY greatest(epon01.level, epon02.level, epon03.level, epon04.level, epon05.level, epon06.level, epon07.level, epon08.level,epon09.level, epon10.level, epon11.level, epon12.level, epon13.level, epon14.level, epon15.level, epon16.level) DESC, main.count DESC; "
            levels_list = Levels.objects.raw(select)

    filter_on_page = request.GET.get('filter_on_page')
    if filter_on_page == None:
        filter_on_page = '10'
    if filter_on_page != 'all':
        paginator = Paginator(levels_list, int(filter_on_page))
        page = request.GET.get('page')
        try:
            levels_list = paginator.page(page)
        except PageNotAnInteger:
            levels_list = paginator.page(1)
        except EmptyPage:
            levels_list = paginator.page(paginator.num_pages)

    context = {'filter_on_page':filter_on_page, 'filter_by_level':filter_by_level, 'levels': levels_list, 'filter_by_olt':filter_by_olt}
    return render(request, 'levels/olt_list.html', context)


def olt_list_diff(request):
    filter_by_diff = request.GET.get('filter_by_diff')
    filter_by_olt = request.GET.get('filter_by_olt')
    if filter_by_olt  == None: filter_by_olt =''
    column = Levels.objects.raw(
        "SELECT 1 id, column_name FROM INFORMATION_SCHEMA. COLUMNS WHERE TABLE_NAME = 'levels_levels'")
    name_column = []
    for item in column:
        if 'level' in item.column_name:
            name_column.append(item.column_name)
    if filter_by_diff == None or filter_by_diff == "":
        filter_by_diff = "-2"
        select = "SELECT 1 id, main.olt, main.count,greatest(epon01.level, epon02.level, epon03.level, epon04.level, epon05.level, epon06.level, epon07.level, epon08.level,epon09.level, epon10.level, epon11.level, epon12.level, epon13.level, epon14.level, epon15.level, epon16.level) as max_on_one_epon, COALESCE(epon01.level, 0) AS epon01, COALESCE(epon02.level, 0) AS epon02, COALESCE(epon03.level, 0) AS epon03, COALESCE(epon04.level, 0) AS epon04, COALESCE(epon05.level, 0) AS epon05, COALESCE(epon06.level, 0) AS epon06, COALESCE(epon07.level, 0) AS epon07, COALESCE(epon08.level, 0) AS epon08, COALESCE(epon09.level, 0) AS epon09, COALESCE(epon10.level, 0) AS epon10, COALESCE(epon11.level, 0) AS epon11, COALESCE(epon12.level, 0) AS epon12, COALESCE(epon13.level, 0) AS epon13, COALESCE(epon14.level, 0) AS epon14, COALESCE(epon15.level, 0) AS epon15, COALESCE(epon16.level, 0) AS epon16 FROM (SELECT olt, COUNT(olt) AS count FROM levels_levels where "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) main LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/1:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon01 ON (main.olt = epon01.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/2:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon02 ON (main.olt = epon02.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/3:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon03 ON (main.olt = epon03.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/4:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon04 ON (main.olt = epon04.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/5:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon05 ON (main.olt = epon05.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/6:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon06 ON (main.olt = epon06.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/7:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon07 ON (main.olt = epon07.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/8:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon08 ON (main.olt = epon08.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/9:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon09 ON (main.olt = epon09.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/10:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon10 ON (main.olt = epon10.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/11:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+"GROUP BY olt) epon11 ON (main.olt = epon11.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/12:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon12 ON (main.olt = epon12.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/13:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon13 ON (main.olt = epon13.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/14:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon14 ON (main.olt = epon14.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/15:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon15 ON (main.olt = epon15.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/16:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon16 ON (main.olt = epon16.olt) ORDER BY greatest(epon01.level, epon02.level, epon03.level, epon04.level, epon05.level, epon06.level, epon07.level, epon08.level,epon09.level, epon10.level, epon11.level, epon12.level, epon13.level, epon14.level, epon15.level, epon16.level) DESC, main.count DESC;"
        levels_list = Levels.objects.raw(select)
    else:
        try:
            select = "SELECT 1 id, main.olt, main.count, greatest(epon01.level, epon02.level, epon03.level, epon04.level, epon05.level, epon06.level, epon07.level, epon08.level,epon09.level, epon10.level, epon11.level, epon12.level, epon13.level, epon14.level, epon15.level, epon16.level) as max_on_one_epon, COALESCE(epon01.level, 0) AS epon01, COALESCE(epon02.level, 0) AS epon02, COALESCE(epon03.level, 0) AS epon03, COALESCE(epon04.level, 0) AS epon04, COALESCE(epon05.level, 0) AS epon05, COALESCE(epon06.level, 0) AS epon06, COALESCE(epon07.level, 0) AS epon07, COALESCE(epon08.level, 0) AS epon08, COALESCE(epon09.level, 0) AS epon09, COALESCE(epon10.level, 0) AS epon10, COALESCE(epon11.level, 0) AS epon11, COALESCE(epon12.level, 0) AS epon12, COALESCE(epon13.level, 0) AS epon13, COALESCE(epon14.level, 0) AS epon14, COALESCE(epon15.level, 0) AS epon15, COALESCE(epon16.level, 0) AS epon16 FROM (SELECT olt, COUNT(olt) AS count FROM levels_levels where "+name_column[-1]+" is not null AND olt LIKE '"+"%%"+filter_by_olt+"%%"+"' and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) main LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/1:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon01 ON (main.olt = epon01.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/2:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon02 ON (main.olt = epon02.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/3:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon03 ON (main.olt = epon03.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/4:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon04 ON (main.olt = epon04.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/5:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon05 ON (main.olt = epon05.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/6:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon06 ON (main.olt = epon06.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/7:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon07 ON (main.olt = epon07.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/8:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon08 ON (main.olt = epon08.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/9:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon09 ON (main.olt = epon09.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/10:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon10 ON (main.olt = epon10.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/11:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+"GROUP BY olt) epon11 ON (main.olt = epon11.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/12:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon12 ON (main.olt = epon12.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/13:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon13 ON (main.olt = epon13.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/14:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon14 ON (main.olt = epon14.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/15:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon15 ON (main.olt = epon15.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/16:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon16 ON (main.olt = epon16.olt) ORDER BY greatest(epon01.level, epon02.level, epon03.level, epon04.level, epon05.level, epon06.level, epon07.level, epon08.level,epon09.level, epon10.level, epon11.level, epon12.level, epon13.level, epon14.level, epon15.level, epon16.level) DESC, main.count DESC;"
            levels_list = Levels.objects.raw(select)
        except:
            select = "SELECT 1 id, main.olt, main.count, greatest(epon01.level, epon02.level, epon03.level, epon04.level, epon05.level, epon06.level, epon07.level, epon08.level,epon09.level, epon10.level, epon11.level, epon12.level, epon13.level, epon14.level, epon15.level, epon16.level) as max_on_one_epon, COALESCE(epon01.level, 0) AS epon01, COALESCE(epon02.level, 0) AS epon02, COALESCE(epon03.level, 0) AS epon03, COALESCE(epon04.level, 0) AS epon04, COALESCE(epon05.level, 0) AS epon05, COALESCE(epon06.level, 0) AS epon06, COALESCE(epon07.level, 0) AS epon07, COALESCE(epon08.level, 0) AS epon08, COALESCE(epon09.level, 0) AS epon09, COALESCE(epon10.level, 0) AS epon10, COALESCE(epon11.level, 0) AS epon11, COALESCE(epon12.level, 0) AS epon12, COALESCE(epon13.level, 0) AS epon13, COALESCE(epon14.level, 0) AS epon14, COALESCE(epon15.level, 0) AS epon15, COALESCE(epon16.level, 0) AS epon16 FROM (SELECT olt, COUNT(olt) AS count FROM levels_levels where "+name_column[-1]+" is not null AND olt LIKE '"+"%%"+filter_by_olt+"%%"+"' and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) main LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/1:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon01 ON (main.olt = epon01.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/2:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon02 ON (main.olt = epon02.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/3:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon03 ON (main.olt = epon03.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/4:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon04 ON (main.olt = epon04.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/5:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon05 ON (main.olt = epon05.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/6:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon06 ON (main.olt = epon06.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/7:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon07 ON (main.olt = epon07.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/8:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon08 ON (main.olt = epon08.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/9:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon09 ON (main.olt = epon09.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/10:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon10 ON (main.olt = epon10.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/11:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+"GROUP BY olt) epon11 ON (main.olt = epon11.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/12:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon12 ON (main.olt = epon12.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/13:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon13 ON (main.olt = epon13.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/14:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon14 ON (main.olt = epon14.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/15:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon15 ON (main.olt = epon15.olt) LEFT JOIN (SELECT olt, COUNT(olt) AS level FROM levels_levels WHERE epon LIKE 'EPON0/16:%%' AND "+name_column[-1]+" is not null and "+name_column[-2]+" is not null and cast("+name_column[-1]+" as FLOAT) <0 and cast("+name_column[-1]+" as FLOAT)>-40 and cast("+name_column[-1]+" as FLOAT) !=(-8) and cast("+name_column[-2]+" as FLOAT) <0 and cast("+name_column[-2]+" as FLOAT)>-40 and cast("+name_column[-2]+" as FLOAT)!=(-8) and cast("+name_column[-1]+" as FLOAT)-cast("+name_column[-2]+" as FLOAT)<"+ str(filter_by_diff)+" GROUP BY olt) epon16 ON (main.olt = epon16.olt) ORDER BY greatest(epon01.level, epon02.level, epon03.level, epon04.level, epon05.level, epon06.level, epon07.level, epon08.level,epon09.level, epon10.level, epon11.level, epon12.level, epon13.level, epon14.level, epon15.level, epon16.level) DESC, main.count DESC;"
            levels_list = Levels.objects.raw(select)
    filter_on_page = request.GET.get('filter_on_page')
    if filter_on_page == None:
        filter_on_page = '10'
    if filter_on_page != 'all':
        paginator = Paginator(levels_list, int(filter_on_page))
        page = request.GET.get('page')
        try:
            levels_list = paginator.page(page)
        except PageNotAnInteger:
            levels_list = paginator.page(1)
        except EmptyPage:
            levels_list = paginator.page(paginator.num_pages)

    context = {'filter_on_page':filter_on_page, 'filter_by_diff':filter_by_diff, 'levels': levels_list, 'filter_by_olt':filter_by_olt}
    return render(request, 'levels/olt_list_diff.html', context)
